// Generated by CoffeeScript 1.6.3
(function() {
  var Chocolate, mongoose, toRender, _;

  console.log("fire index.js");

  mongoose = require('mongoose');

  _ = require('underscore');

  toRender = {
    pageInfo: {
      title: 'Ranked Choice Voting',
      subtitle: 'A Case Study'
    },
    chocolates: ["Milk Chocolate", "Dark Chocolate", "White Chocolate", "Snickers", "Twix", "Cadbury", "Milky Way", "Hershey's"],
    cakes: ["Chocolate", "Red Velvet", "Ice Cream", "Hot Milk", "Birthday", "Wedding", "Angel Food", "Cakelette"],
    fruits: ["Banana", "Lemon", "Grape", "Kiwi", "Watermelon", "Apple", "Orange", "Dragonfruit"]
  };

  Chocolate = mongoose.model('Chocolate', {
    firstChoice: String,
    secondChoice: String,
    thirdChoice: String,
    choices: Array || String
  });

  module.exports = {
    index: function(req, res) {
      return res.render('index', toRender);
    },
    chocolate: function(req, res) {
      var chocolate, data, vote;
      data = req.query;
      console.log("data:::", data);
      vote = {
        firstChoice: data.type[0],
        secondChoice: data.type[1],
        thirdChoice: data.type[2],
        choices: toRender.chocolates
      };
      console.log("vote::::", vote);
      chocolate = new Chocolate(vote);
      return chocolate.save(function(err, data) {
        return console.log("sent to database:", data);
      });
    },
    tabulate: function(req, res) {
      console.log("made it to routes.tabulate");
      return Chocolate.find(function(err, votes) {
        var histogram, mappedGram, mappedVotes, tabulatedObjectToRender, totalVotes;
        if (err) {
          return console.log('ERROR');
        } else {
          console.log('votes', votes);
          mappedVotes = _.map(votes, function(vote) {
            return vote;
          });
          console.log("mappedVotes", mappedVotes);
          totalVotes = mappedVotes.length;
          histogram = _.groupBy(mappedVotes, 'firstChoice');
          console.log("histogram", histogram);
          mappedGram = _.map(histogram, function(grouping) {
            var choice, message, percentage;
            choice = grouping[0].firstChoice;
            percentage = (100 * grouping.length) / totalVotes;
            if (percentage > 50) {
              message = "Winner!";
            } else {
              message = "";
            }
            return {
              choice: choice,
              votes: grouping.length,
              percentage: percentage,
              message: message
            };
          });
          console.log(",MappedGram:::", mappedGram);
          tabulatedObjectToRender = {
            title: "Tabulated Results",
            choice: "chocolate",
            firstRoundResults: mappedGram,
            secondRoundResults: "second round results"
          };
          return res.render('tabulate', tabulatedObjectToRender);
        }
      });
    }
  };

}).call(this);
